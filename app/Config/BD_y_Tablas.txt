CREATE DATABASE IF NOT EXISTS mediagend
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

USE mediagend;

################ ADMINISTRADOR ################

CREATE TABLE administrador (
  id_admin INT AUTO_INCREMENT PRIMARY KEY,
  nombre_admin VARCHAR(100) NOT NULL,
  apellidos_admin VARCHAR(100) NOT NULL, 
  dni_admin VARCHAR(9) NOT NULL, 
  email_admin VARCHAR(100) UNIQUE NOT NULL,
  usuario_admin VARCHAR(50) UNIQUE NOT NULL,
  password_admin VARCHAR(255) NOT NULL
) ENGINE=InnoDB;

################ CLINICA ################

CREATE TABLE clinica (
  id_clinica INT AUTO_INCREMENT PRIMARY KEY,
  id_admin INT NOT NULL,
  foto_clinica VARCHAR(150),
  usuario_admin_clinica VARCHAR(50),
  nombre_clinica VARCHAR(150) NOT NULL,
  nif_clinica VARCHAR(9) NOT NULL, 
  direccion_clinica VARCHAR(200),
  telefono_clinica VARCHAR(20),
  email_clinica VARCHAR(100),
  usuario_clinica VARCHAR(50) UNIQUE NOT NULL,
  password_clinica VARCHAR(255) NOT NULL,

  CONSTRAINT fk_clinica_admin
    FOREIGN KEY (id_admin)
    REFERENCES administrador(id_admin)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB;

################ MEDICO ################

CREATE TABLE medico (
  id_medico INT AUTO_INCREMENT PRIMARY KEY,
  id_clinica INT NOT NULL,
  numero_colegiado VARCHAR(150) NOT NULL,
  nombre_medico VARCHAR(100) NOT NULL,
  apellidos_medico VARCHAR (150) NOT NULL,
  dni_medico VARCHAR(9) NOT NULL, 
  especialidad_medico VARCHAR(100),
  telefono_medico VARCHAR(20),
  email_medico VARCHAR(100),
  foto_medico VARCHAR(150),
  password_medico VARCHAR(255) NOT NULL,

  CONSTRAINT fk_medico_clinica
    FOREIGN KEY (id_clinica)
    REFERENCES clinica(id_clinica)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB;

################ PACIENTE ################

CREATE TABLE paciente (
  id_paciente INT AUTO_INCREMENT PRIMARY KEY,
  id_clinica INT NOT NULL,
  id_medico INT,
  dni_paciente VARCHAR(9) NOT NULL,
  nombre_paciente VARCHAR(100) NOT NULL,
  apellidos_paciente VARCHAR(150),
  telefono_paciente VARCHAR(20),
  password_paciente VARCHAR(255) NOT NULL,
  usuario_paciente VARCHAR(150) NOT NULL,
  email_paciente VARCHAR(100),
  foto_paciente VARCHAR(150),

  UNIQUE (dni_paciente, id_clinica),

  CONSTRAINT fk_paciente_clinica
    FOREIGN KEY (id_clinica)
    REFERENCES clinica(id_clinica)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB;

################ INFORME ################

CREATE TABLE informe (
  id_informe INT AUTO_INCREMENT PRIMARY KEY,
  id_clinica INT NOT NULL,
  id_cita INT,
  id_medico INT NOT NULL,
  id_paciente INT NOT NULL,
  diagnostico_informe TEXT,
  tratamiento_informe TEXT,
  fecha_generacion_informe DATETIME DEFAULT CURRENT_TIMESTAMP,
  archivo_pdf_informe VARCHAR(255),

  CONSTRAINT fk_informe_clinica
    FOREIGN KEY (id_clinica)
    REFERENCES clinica(id_clinica)
    ON DELETE CASCADE,

  CONSTRAINT fk_informe_medico
    FOREIGN KEY (id_medico)
    REFERENCES medico(id_medico),
    
  CONSTRAINT fk_informe_paciente
    FOREIGN KEY (id_paciente)
    REFERENCES paciente(id_paciente)
    ON DELETE CASCADE
) ENGINE=InnoDB;

################ CITA ################

CREATE TABLE cita (
  id_cita INT AUTO_INCREMENT PRIMARY KEY,
  id_clinica INT NOT NULL,
  id_paciente INT NULL,
  id_medico INT NOT NULL,
  id_informe INT,
  fecha_cita DATE NOT NULL,
  hora_cita TIME NOT NULL,
  estado_cita ENUM('pendiente', 'confirmada', 'no_asiste', 'realizada') DEFAULT 'pendiente',
  motivo_cita VARCHAR(255),

  CONSTRAINT fk_cita_clinica
    FOREIGN KEY (id_clinica)
    REFERENCES clinica(id_clinica)
    ON DELETE CASCADE,

  CONSTRAINT fk_cita_paciente
    FOREIGN KEY (id_paciente)
    REFERENCES paciente(id_paciente)
    ON DELETE CASCADE,

  CONSTRAINT fk_cita_medico
    FOREIGN KEY (id_medico)
    REFERENCES medico(id_medico)
    ON DELETE CASCADE
) ENGINE=InnoDB;

################ RELACIÃ“N INFORME-CITA ################

ALTER TABLE informe
ADD CONSTRAINT fk_informe_cita
FOREIGN KEY (id_cita)
REFERENCES cita(id_cita)
ON DELETE SET NULL;